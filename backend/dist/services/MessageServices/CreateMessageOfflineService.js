'use strict';
const H = b, I = b;
function b(c, d) {
    const e = a();
    return b = function (f, g) {
        f = f - (-0x64c + 0x16a7 * 0x1 + -0xf05);
        let h = e[f];
        return h;
    }, b(c, d);
}
(function (c, d) {
    const F = b, G = b, e = c();
    while (!![]) {
        try {
            const f = parseInt(F(0x1b2)) / (-0x2480 + 0x12 * 0xd4 + -0x1599 * -0x1) + -parseInt(F(0x1ae)) / (0x4ee + 0x1a9 * 0x7 + 0x34f * -0x5) * (-parseInt(G(0x181)) / (0xcc7 * 0x2 + -0x224f + 0x8c4)) + -parseInt(F(0x1b7)) / (0x3 * -0x6e9 + 0x1408 + 0xb7) * (parseInt(F(0x17e)) / (-0x107 * -0x5 + 0x24db + -0x5 * 0x865)) + -parseInt(F(0x15a)) / (0x11e7 * -0x2 + -0x739 + 0x2b0d * 0x1) + -parseInt(F(0x15d)) / (0x215 * 0x1 + -0xd * -0x257 + -0x1 * 0x2079) + -parseInt(F(0x15b)) / (-0x1cf8 + 0x20b * 0x7 + 0xeb3) + -parseInt(F(0x182)) / (0x1 * -0x22c2 + 0x1 * -0xac4 + 0x2d8f) * (-parseInt(F(0x1be)) / (0x2029 * -0x1 + 0xf4 * -0x10 + 0x2f73));
            if (f === d)
                break;
            else
                e['push'](e['shift']());
        } catch (g) {
            e['push'](e['shift']());
        }
    }
}(a, 0x422c3 * 0x1 + -0x252d9 + -0x617 * -0x72));
var __importDefault = this && this[H(0x1b3) + I(0x1af)] || function (c) {
    const J = H;
    return c && c[J(0x183)] ? c : { 'default': c };
};
function a() {
    const O = [
        'OEhid',
        'default',
        'OkXCA',
        'ROdiz',
        'ticket',
        'base64',
        'buffer',
        'skbsX',
        'qYktb',
        'erty',
        's/logger',
        'nOSTr',
        'SvQLl',
        'CreateMess',
        'getIO',
        'toString',
        'logger',
        'error',
        'tenantId',
        'IHCbf',
        'substr',
        'findByPk',
        'contact',
        'map',
        'ion',
        'mimetype',
        'writeFile',
        'all',
        'FlqlE',
        'jGnZZ',
        'ls/Ticket',
        'util',
        'promisify',
        'body',
        'create',
        '../../util',
        'wNRPK',
        'split',
        'pTppW',
        '26BUeHva',
        'fault',
        '../../libs',
        'fVMRM',
        '350194RGJWtJ',
        '__importDe',
        'status',
        'AIlrG',
        '../../mode',
        '8PkKnKa',
        'deugx',
        'update',
        'userId',
        'Service',
        'path',
        'join',
        '20wDZMMI',
        'IKEXn',
        'PZkuX',
        'KJALv',
        'getTime',
        'value',
        'quotedMsg',
        '983124iPxReG',
        '1240552ntuCyM',
        'Jcyjm',
        '3233048mDMZAT',
        'rWojK',
        'ZOdxe',
        'fromMe',
        '-appMessag',
        'chat',
        'OffLine',
        'ls/Message',
        'iwEtr',
        'hyNti',
        '/socket',
        'ticketId',
        'defineProp',
        'NG_MESSAGE',
        '-notificat',
        'ERR_CREATI',
        'hEWOv',
        'timestamp',
        'mediaType',
        'include',
        'jIaOJ',
        'fpswS',
        'psNRT',
        'emit',
        'WtXQG',
        'indexOf',
        'filename',
        'contactId',
        'mediaUrl',
        'public',
        'IRsFI',
        'wId',
        'veVLW',
        '262075YCQfNa',
        'NXUog',
        'yYMqD',
        '13593NpSyTA',
        '3478536dulJnL',
        '__esModule',
        'MrBHM',
        'ageOffLine',
        'read'
    ];
    a = function () {
        return O;
    };
    return a();
}
const k = {};
k[I(0x158)] = !![], Object[H(0x169) + H(0x190)](exports, H(0x183), k);
const fs_1 = require('fs'), util_1 = require(I(0x1a6)), path_1 = require(I(0x1bc)), logger_1 = require(I(0x1aa) + H(0x191)), MessageOffLine_1 = __importDefault(require(I(0x1b6) + I(0x164) + I(0x163))), socket_1 = require(I(0x1b0) + H(0x167)), Ticket_1 = __importDefault(require(H(0x1b6) + H(0x1a5))), Message_1 = __importDefault(require(H(0x1b6) + H(0x164))), writeFileAsync = (0x157 + -0xdd2 * 0x2 + -0x1a4d * -0x1, util_1[I(0x1a7)])(fs_1[H(0x1a1)]), CreateMessageOffilineService = async ({
        msg: g,
        tenantId: h,
        medias: i,
        ticket: j,
        userId: l
    }) => {
        const K = I, L = H, m = {
                'OkXCA': K(0x16c) + L(0x16a),
                'IKEXn': L(0x194) + K(0x185) + K(0x1bb),
                'yYMqD': function (q, r) {
                    return q !== r;
                },
                'deugx': L(0x18f),
                'OEhid': L(0x15f),
                'skbsX': function (q, r) {
                    return q !== r;
                },
                'MrBHM': K(0x156),
                'pTppW': K(0x192),
                'NXUog': function (q, r) {
                    return q === r;
                },
                'hyNti': L(0x1c0),
                'hEWOv': function (q, r, s, t) {
                    return q(r, s, t);
                },
                'iwEtr': L(0x17a),
                'WtXQG': K(0x18c),
                'jIaOJ': K(0x1a3),
                'psNRT': L(0x1b1),
                'ROdiz': K(0x19d),
                'fpswS': L(0x18b),
                'IRsFI': K(0x159),
                'Jcyjm': K(0x17d),
                'AIlrG': L(0x1a9),
                'IHCbf': K(0x162),
                'SvQLl': function (q, r) {
                    return q === r;
                },
                'rWojK': K(0x1ab)
            }, n = (0x1522 + -0x153a + 0xc * 0x2, socket_1[L(0x195)])(), o = {};
        o[K(0x17c)] = undefined, o[K(0x168)] = j['id'], o[K(0x1a8)] = g[L(0x1a8)], o[L(0x178)] = j[K(0x178)], o[K(0x160)] = g[K(0x160)], o[L(0x186)] = !![], o[L(0x16f)] = m[L(0x19a)], o[L(0x179)] = undefined, o[L(0x16e)] = undefined, o[K(0x1ba)] = l;
        const p = o;
        try {
            if (i)
                m[L(0x193)](m[L(0x15e)], m[L(0x15e)]) ? await Promise[K(0x1a2)](i[K(0x19e)](async q => {
                    const M = L, N = K, r = {};
                    r[M(0x1a4)] = m[M(0x1bf)];
                    const s = r;
                    if (m[M(0x180)](m[M(0x1b8)], m[M(0x187)])) {
                        try {
                            if (m[M(0x18e)](m[M(0x184)], m[M(0x1ad)])) {
                                if (!q[M(0x177)]) {
                                    if (m[N(0x17f)](m[M(0x166)], m[N(0x166)])) {
                                        const y = q[M(0x1a0)][N(0x1ac)]('/')[0x2590 + 0x2661 + -0x4bf0][M(0x1ac)](';')[0x1ab * -0x17 + -0x1 * -0x1d99 + -0x2c * -0x33];
                                        q[N(0x177)] = new Date()[N(0x157)]() + '.' + y;
                                    } else
                                        throw new r(m[N(0x189)]);
                                }
                                await m[M(0x16d)](writeFileAsync, (0x9 * -0x1da + 0x119f * -0x1 + 0x2249, path_1[N(0x1bd)])(__dirname, '..', '..', '..', '..', m[M(0x165)], q[M(0x177)]), q[M(0x18d)], m[N(0x175)]);
                            } else {
                                const B = w[N(0x1a0)][M(0x1ac)]('/')[0x1517 + -0x1 * 0x1e39 + -0x923 * -0x1][M(0x1ac)](';')[-0x202a + 0x11ed + 0xe3d];
                                g[M(0x177)] = new h()[M(0x157)]() + '.' + B;
                            }
                        } catch (B) {
                            if (m[M(0x17f)](m[M(0x171)], m[M(0x173)]))
                                throw new r(m[N(0x189)]);
                            else
                                logger_1[M(0x197)][N(0x198)](B);
                        }
                        const t = {
                                ...p,
                                'mediaUrl': q[N(0x177)],
                                'mediaType': q[M(0x1a0)][M(0x19b)](-0x125b * -0x2 + -0x1 * 0xe78 + -0x163e, q[M(0x1a0)][N(0x176)]('/'))
                            }, u = await MessageOffLine_1[N(0x188)][M(0x1a9)](t), v = {};
                        v[N(0x199)] = h;
                        const w = {};
                        w[N(0x170)] = [
                            m[N(0x18a)],
                            {
                                'model': Ticket_1[N(0x188)],
                                'as': m[M(0x172)],
                                'where': v,
                                'include': [m[M(0x18a)]]
                            },
                            {
                                'model': Message_1[M(0x188)],
                                'as': m[N(0x17b)],
                                'include': [m[M(0x18a)]]
                            }
                        ];
                        const x = await MessageOffLine_1[M(0x188)][M(0x19c)](u['id'], w);
                        if (!x) {
                            if (m[N(0x17f)](m[M(0x15c)], m[N(0x15c)]))
                                throw new Error(m[M(0x189)]);
                            else {
                                const E = {};
                                return E[N(0x188)] = j, E && h[N(0x183)] ? i : E;
                            }
                        }
                        n['to'](h + '-' + x[N(0x168)][N(0x196)]())['to'](h + '-' + x[M(0x18b)][N(0x1b4)])['to'](h + (M(0x16b) + N(0x19f)))[N(0x174)](h + (M(0x161) + 'e'), {
                            'action': m[M(0x1b5)],
                            'message': x,
                            'ticket': x[N(0x18b)],
                            'contact': x[N(0x18b)][N(0x19d)]
                        }), await j[M(0x1b9)]({
                            'lastMessage': x[M(0x1a8)],
                            'lastMessageAt': new Date()[N(0x157)]()
                        });
                    } else
                        e[M(0x197)][N(0x198)](s[M(0x1a4)], f);
                })) : e[L(0x197)][L(0x198)](f);
            else {
                const r = { ...p };
                r[L(0x16f)] = m[L(0x19a)];
                const s = await MessageOffLine_1[K(0x188)][L(0x1a9)](r), t = {};
                t[L(0x199)] = h;
                const u = {};
                u[K(0x170)] = [
                    m[L(0x18a)],
                    {
                        'model': Ticket_1[L(0x188)],
                        'as': m[L(0x172)],
                        'where': t,
                        'include': [m[L(0x18a)]]
                    },
                    {
                        'model': Message_1[K(0x188)],
                        'as': m[K(0x17b)],
                        'include': [m[L(0x18a)]]
                    }
                ];
                const v = await MessageOffLine_1[L(0x188)][L(0x19c)](s['id'], u);
                if (!v)
                    throw new Error(m[L(0x189)]);
                await j[K(0x1b9)]({
                    'lastMessage': v[L(0x1a8)],
                    'lastMessageAt': new Date()[K(0x157)]()
                }), n['to'](h + '-' + v[L(0x168)][L(0x196)]())['to'](h + '-' + v[K(0x18b)][K(0x1b4)])['to'](h + (K(0x16b) + L(0x19f)))[L(0x174)](h + (L(0x161) + 'e'), {
                    'action': m[K(0x1b5)],
                    'message': v,
                    'ticket': v[L(0x18b)],
                    'contact': v[K(0x18b)][K(0x19d)]
                });
            }
        } catch (w) {
            logger_1[L(0x197)][L(0x198)](m[L(0x1bf)], w);
        }
    };
exports[I(0x188)] = CreateMessageOffilineService;